# Sesión IA 2025-12-03 (Flow Builder)

Contexto rápido para retomar:
- Ajustamos el prompt TOON para tono humano peruano, usar “reservar/separar” (no “agendar”), y en horario laboral transferir para datos exactos de precio/stock/tallas.
- Añadimos RAG de patrones (`data/embeddings-db-patterns.json`) para reforzar saludo peruano y evitar “agendar”.
- Validación promotora: respuesta cálida “Hola {nombre}! ¿En qué puedo ayudarte hoy?”; cache de validación en sesión para no revalidar.
- Opt-in Bitrix: “por confirmar” (96424) obliga a preguntar de nuevo; sólo 96420/96422 se consideran definitivos.
- Post-procesado de respuestas: `normalizeTextResponse` en `server/ai/agent-executor.ts` agrupa en párrafos (evita renglón por renglón).
- Prompt reforzado: `data/system-prompt-final.txt` incluye formato 1-2 párrafos, sin viñetas ni renglón a renglón.

Proceso:
- Servicio activo: `systemctl status flowbuilder` (corre `npm exec tsx server/index.ts` en /opt/flow-builder).
- Logs recientes: `logs/combined-2025-12-03.log` y `logs/server-2025-12-03_165358.log`.

Pendientes sugeridos (no hechos):
- Auto-transfer en horario laboral cuando pidan precio/stock/talla exacta (regla explícita en runtime).
- Pipeline de extracción/curación de chats 45 días y reindexar patrones RAG de forma periódica.
